import flask
import requests
import random
import json
import os
from dotenv import load_dotenv, find_dotenv

load_dotenv(find_dotenv())

def get_movie_info():
    TMDB_BASE_URL = "https://api.themoviedb.org/3"
    TMDB_MOVIE_LIST_PATH = ["/movie/634649", "/movie/361743", "/movie/324786"]
    TMDB_MOVIE_PATH = random.choice(TMDB_MOVIE_LIST_PATH)

    movie_response = requests.get(
        TMDB_BASE_URL + TMDB_MOVIE_PATH,
        params={
        "api_key": os.getenv("TMDB_API_KEY"),
        },
    )

    movie_info = movie_response.json()

    MOVIE_NAME = movie_info["title"]
    MOVIE_TAGLINE = movie_info["tagline"]
    MOVIE_POSTER_PATH = movie_info["poster_path"]
    MOVIE_POSTER_IMAGE = get_movie_poster(MOVIE_POSTER_PATH)
    MOVIE_GENRES = [genre["name"] for genre in movie_info["genres"]]
    MOVIE_WIKI_LINK = get_wiki_link(MOVIE_NAME)    

def get_movie_poster(MOVIE_POSTER_PATH):
    TMDB_MOVIE_POSTER_BASE_URL = "https://image.tmdb.org/t/p"
    POSTER_SIZE = "/w500"

    return TMDB_MOVIE_POSTER_BASE_URL + POSTER_SIZE + MOVIE_POSTER_PATH

def get_wiki_link(MOVIE_NAME):
    WIKI_BASE_URL = "https://www.wikipedia.org/w/api.php"

    wiki_response = requests.get(
        WIKI_BASE_URL,

        params={
        "action": "query",
        "prop": "info",
        "inprop": "url",
        "format": "json",
        "titles": MOVIE_NAME,
        },
    )

    wiki_link = wiki_response.json()["query"]["pages"][
        list(wiki_response.json()["query"]["pages"])[0]]["fullurl"]
    
    return wiki_link


app = flask.Flask(__name__)

@app.route("/")
def index(MOVIE_NAME, MOVIE_TAGLINE, MOVIE_POSTER_PATH, MOVIE_GENRES, MOVIE_WIKI_LINK):
    return flask.render_template("moviediscovery.html",
    TITLE = MOVIE_NAME,
    TAGLINE = MOVIE_TAGLINE,
    POSTER = MOVIE_POSTER_PATH,
    GENRES = MOVIE_GENRES,
    WIKI = MOVIE_WIKI_LINK
    )

get_movie_info()
app.run()